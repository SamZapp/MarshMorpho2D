
%load in parameters (P)

[N,M,dx,A,z,Active,x,y,msl]=initializegeometry(P);
zbed=tst15; %use whatever tst you want
msl=0;
z=zbed+msl;

% A=ones(1500,500);
% %sea b.c.
% A(end,:)=2;
numberserie=10000;
dtOserie=ones(numberserie,1)*365;

time=cumsum(dtOserie)/365; %converted to years, just to plot. Does not affect the computation
time=[time(2:end);time(end)];
%SeaWave direction
angleWINDserie=rand(numberserie,1)*360;
angleWIND=angleWINDserie(end);
dto=0.00001;dt=dto;
fIO.FLXz=FLXz;
fIO.pondloss=pondloss;
fIO.KBTOT=KBTOT;
fIO.zOX=zOX;
tmax=1000;
t=tmax;

%[IOtemp,fIOtemp,maxdeltaz,maxup,PLT]=mainevolutionstep(A,P,dx,dt,IO,fIO,angleWIND,t);
%%
%now run main evolutopn step to solve for hydrodynamics
%Load the parameters and variables
names = fieldnames(IO);
for i=1:length(names);eval([names{i} '=IO.' names{i} ';' ]);end

names = fieldnames(fIO);
for i=1:length(names);eval([names{i} '=fIO.' names{i} ';' ]);end

names = fieldnames(P);
for i=1:length(names);eval([names{i} '=P.' names{i} ';' ]);end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

[N,M]=size(A);
optionBC=2; %impose water depth (for sea boundary)


zoriginal=z;



%Hydrodynamic%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Sea level
msl=msl+RSLR*dt;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Make the upland cells active
Active((z-msl)<Trange/2)=1;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%Pond dynamics%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Need to run it first because it affects the vegetation through S !!!!!
if calculateponddynamics==1     %%CHECK THE SIGN OF z!!!
zsill=Trange/2;  
%use lev instead of z to be rleative to MSL!!!
[deltaz,pondloss]=pondformation(A,dx,dt,Epondform,z-msl,zpondcr,maxdpond,zsill,pondloss);z=z-deltaz;
[S,AC,DIF]=findisolatedponds(z-msl,A,N,M,dx,zntwrk,zsill,NaN,minponddepth);%AC is only used for plotting, not in the computation   
%DIF is the amount of water impunded at low water. It is the remainng water depth in the pond!
%S(lev<dBlo)=0;% the ponds in the mudflats are not really a pond! You need to put it otherwise probelm with bedcreeppond. YOU CANNOT CREEP IN PONDS
[S,deltaz,pondloss]=isolatedpondexpansion(z-msl,S,A,N,M,dx,dt,zpondcr,maxdpond,aPEXP,pondloss);z=z-deltaz;
[deltaz,pondloss]=isolatedponddeepening(z-msl,S,ponddeeprate,dt,pondloss);z=z-deltaz;
else;AC=A*0;S=A*0;
end;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%Water depth
[h,ho,fTide,dtide,dsurge,dHW,wl,wlo]=getwaterdepth(Trange,msl,z,kro,0);


%Vegetation%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
if VEGETATION==1;
Zlev=z-msl;
VEG=Zlev>dBlo;
B=4*(Zlev-dBup).*(dBlo-Zlev)/(dBlo-dBup)^2;B(Zlev>dBup)=0;B(Zlev<dBlo)=0;  %B=(dBup-lev)/(dBup-dBlo);B(lev>dBup)=0;B(lev<dBlo)=0;
else;VEG=A*0;B=A*0;end
B=B.*(S==0);%no biomass where there are ponds
VEG=VEG.*(S==0);%no vegeation where there are ponds
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%Manning%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
MANN=0*A+Cb;
MANN(VEG==1)=Cv;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%Tide&Surge flow%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
if computetide==1;
%dtide(S==1)=min(dtide(S==1),(Trange/2)*0.2);%to limit the effect of ponds on the tidal prism. Speth 2019    %%%%dtide(S==1)=0;%tolgi tutta l aqaua del tidal prism dalle pozze%to limit the effect of ponds on the tidal prism. Speth 2019

if calculateponddynamics==1;
%DIF is the impounded water depth, need to subtract to the imput discharge from the ponded area (THE WATER REMAINS THERE!!!)
pondleakage=0.2;%[m] this is the water that might drain from a pond below the pond rim. 
%It can be put equal to zero without having a big effect. The larger this value, the more the isolate ponds contribute to the tidal range 
%(even when they techinically are not been drained)
DIF=max(DIF,0); %you cannot impound a negative water depth!!! This happens because of the trick used to swap the cell during the pond floodin
DIFo=DIF;
dtideI=Trange/2-(z-msl)-DIFo;
dtide(S==1)=max(0, Trange/2-(z(S==1)-msl)-max(0,DIFo(S==1)-pondleakage));
fTide(S==1)=0.01;%
end
DHeff=min(Trange,dtide);%the water level excusrion for the total water prismmin

[U,Uy,Ux]=tidalFLOW(A,MANN,h,ho,dHW,dx,DHeff,Ttide,periodic,kro);
U(A==10)=0;Ux(A==10)=0;Uy(A==10)=0;
else;U=0*A;Uy=0*A;Ux=0*A;end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%SeaWaves %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
if computeSeaWaves==1
MASK=0*A+1;
MASK(ho<=hwSea_lim | A==0 | VEG==1 | Zlev>=dBlo)=0;
[Uwave_sea,Tp_sea,Hsea,Fetch,kwave,PWsea]=SeaWaves(h,angleWIND,hwSea_lim,Trange,wind,MASK,64,dx); %72,dx
Uwave_sea=Uwave_sea.*(VEG==0 & S==0); Hsea=Hsea.*(VEG==0 & S==0); %vegetation effect and no waves in isolated pond 9because we also redcued ws!!1)%Uwave_sea=Uwave_sea.*(VEG==0); Hsea=Hsea.*(VEG==0); %vegetation effect
else;Uwave_sea=0*A;Tp_sea=0*A;Hsea=0*A;Fetch=0*A;QsWslope_sea=0*A;end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%Wave-induced edge erosion%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
if (computeEdgeErosionSea==1 | computeEdgeErosionSwell==1)%%%MASK=0*A+1;MASK(h<hwSea_lim | A==0)=0;
PW=A*0;
    if computeEdgeErosionSea==1
    PW=PW+PWsea.*fTide; %Wave power reduction for hydroperiod
    end    
[deltaz,Pedge,zOX,EdgeERz]=Edgeerosion(PW,z,aw,maxedgeheight,fox,dt,dx,MASK,A,zOX);
z=z-deltaz;

%Redistribute the eroded sediment 
EDGESED=diffuseedgesediments((A==1),EdgeERz,1*h,dx); 
z=z+EDGESED;
else;Pedge=A*0;end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%MORPHODYNAMICS%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%CURRENT-DRIVEN TRANSPORT (Tide and River)%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
if (computetide==1 | computeriver==1)  

    %(2)Total sediment resupension MUD
            [E2,E2tide]=totalsedimenterosionMUDsine(U,MANN,VEG,fTide,NaN,Uwave_sea,NaN,Tp_sea,NaN,NaN,1,NaN,taucr,taucrVEG,me,h,Zlev,TrangeVEG,computeSeaWaves,0,0);   
            E2(A==2)=0; %needed for b.c.
                
    %Advection-Diffusion Sediment transport
        WS=A*0+ws2;
        WS(VEG==1)=wsB;           
        WS(S==1)=ws2;%SHOULD NOT BE NECEEARY BECUASE VEG alreeady set equal to zero where S=1 (see above).  ->Do not add the vegetation settling velocity in the ponds! %WS(S==1)=0.000000000001;%E2(S==1)=0;
        [EmD2,SSM,FLXz]=sedtran(1,h,A,DoMUD,DiffSmud,h,ho,E2,WS,dx,dt,rbulk2,co2,Ux,Uy,FLXz,fTide,Ttide,NaN,NaN,NaN,NaN,periodic,0,computetide,0,kro,1,NaN,NaN);   
    else;EmD2=0*A;SSM=0*A;end
    SSC2=SSM./h;
    %SSC2fh=SSC2./fTide;  %just id you want to plot it
    
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%Bed evolution erosion/depositon from tidal and river transport
z=imposeboundarydepth(A,z,optionBC,NaN);
z=z-dt*EmD2;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%Organic accretion%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
B=B.*(S==0);
if AccreteOrganic==1
    z=z+B*Korg*dt; % putorganic on mud!!!
end
KBTOT=KBTOT+sum(B(A==1))*Korg*dt;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%BED EVOLUTION VERTICAL FLUXES%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Update the  bed using: 1)Current transport 2)Edge Erosion 3)Organic growth
%this will allow to next compute the evolution by divergence!!!
znew=z;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%BED EVOLUTION DIVERGENCE%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%EVOLUTION OF z 
z=znew;  %NEED TO RE-UDPATED FROM THE Y1
Qs2=E2tide./(ws2*3600*24).*U.*max(0,h); %kg/m/s %[hcorrected]=getwaterdepth(Trange,Hsurge,msl,z,kro,hpRIV);  %VEG=(z-msl)>dBlo;
znew=bedcreepponds(z,A,Active,A*0+1,crMUD,crMARSH,dx,dt,VEG,S,Qs2,rbulk2,alphaMUD);  %MUD CREEP  MARSH
deltaz=z-znew;
deltaz(A==2)=0;  %DO NOT UPDATE THE BOUNDARY
z=z-deltaz;
 
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%IMPOSE "NEUMAN" boundary condition for morphodynamics%%%%%%%%%%%%%%%%%%
%Traslate the first boundary cell bed elevetion
if imposeseaboundarydepthmorphoALL==1;
        z=seaboundaryNeumanbedelevationALLBOUNDARY(A,z);
else
        z(A==2)=z(A==2)+RSLR*dt;
end


%%%%%%%%%%%%%%%%%END OF MORPHODYNAMICS%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%









%%%%%%%%%% NUMERICAL CHECKS%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
maxdeltaz=prctile(abs(znew(:)-zoriginal(:)),99.9);
MMM=(znew-zoriginal).*((znew)>(msl+Trange/2));
muchup=max(0,max(0,znew-zoriginal)).*((znew)>(msl+Trange/2));%modieif on Oct 2019
maxup=max(muchup(:));%maxup=prctile(muchup(:),99.9);
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%OUTPUTS%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
names = fieldnames(IO);
for i=1:length(names);eval(['IO.' names{i} '=' names{i} ';' ]);end

names = fieldnames(fIO);
for i=1:length(names);eval(['fIO.' names{i} '=' names{i} ';' ]);end


%List here what you want to pass to the main function, so that you can plot it
PLT.PW=PW;
PLT.wl=wl;
PLT.wlo=wlo;
PLT.U=U;
PLT.SSC2=SSC2;
PLT.Tp_sea=Tp_sea;
PLT.Uwave_sea=Uwave_sea;
PLT.Hsea=Hsea;
PLT.Fetch=Fetch;
PLT.EmD2=EmD2;
PLT.Pedge=Pedge;
PLT.Ux=Ux;
PLT.Uy=Uy;
PLT.h=h;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
%%%%%%%%%%%%%%%%%%
%%
%isolate features





%%